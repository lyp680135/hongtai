@page
@model WarrantyManage.Pages.Manage.Quality.SmeltListModel
@inject Common.IService.IUserService userService
@inject DataLibrary.DataContext db
<html>
<head>
    <meta charset="utf-8">
    <title>历史记录</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    @{ await Html.RenderPartialAsync("_ValidationCssPartial");}
    <style>
        .layui-table td {
            text-indent: 0px;
        }
    </style>
</head>
<body style="padding:5px;">
    <form method="get" class="layui-form">
        <div class="tools">
            <ul class="seachform" style="width:100%">
                <li>
                    <label>
                        按冶炼炉号查询:
                    </label>
                    <input type="text" style="width:100px" class="date scinput" id="SmeltCode" name="SmeltCode" value="@Model.SmeltCode" />
                    <div class="layui-input-inline" style="width:150px;">
                        <select id="chemistryshopId" name="chemistryshopId" lay-filter="chemistryshopId">
                            @foreach (var item in Model.List_workShop)
                            {
                                @if (Model.ChemistryshopId == item.Id)
                                {
                                    <option value="@item.Id" selected="selected">@item.Name</option>
                                }
                                else
                                {
                                    <option value="@item.Id">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div style="clear:both"></div>
                </li>
                <li>
                    @if (!string.IsNullOrEmpty(Model.Type))
                    {
                        <input name="Type" hidden="hidden" value="Physicsinfo" id="Type" />
                        <button id="addBtn" name="sb" class="layui-btn layui-btn-sm layui-btn-normal"><i class="layui-icon">&#xe615;</i>查询</button>
                    }
                    else
                    {
                        <button id="addBtn" name="sb" class="layui-btn layui-btn-sm layui-btn-normal"><i class="layui-icon">&#xe615;</i>查询</button>
                    }
                </li>
            </ul>
        </div>
        <table class="layui-table" style="width:1000px">
            <thead>
                <tr>
                    @{
                        if (Model.ManageModels.Count > 0)
                        {
                            <td>创建时间</td>
                            <td>录入人</td>
                            <td>冶炼炉号</td>
                            if (string.IsNullOrEmpty(Model.Type))
                            {
                                <td>状态</td>
                            }

                            var obj = Model.ManageModels.FirstOrDefault();
                            var jobj = (Newtonsoft.Json.Linq.JObject)obj.Chemistry.Object;
                            foreach (var item in jobj)
                            {
                                <td>@item.Key</td>
                            }
                            if (string.IsNullOrEmpty(Model.Type))
                            {
                                <td>操作</td>
                            }

                        }
                    }
                </tr>
            </thead>
            <tbody>
                @{
                    if (Model.ManageModels.Count > 0)
                    {
                        foreach (var item in Model.ManageModels)
                        {
                            <tr SmeltCode="@item.SmeltCode" SId="@item.Id">
                                <td>@Util.Extensions.GetDateTimeFromUnixTime(item.Createtime.ToLong()).ToString("yyyy/MM/dd")</td>
                                <td>
                                    @{
                                        var EntryPerson = db.MngAdmin.FirstOrDefault(c => c.Id == item.EntryPerson);
                                        if (EntryPerson != null)
                                        {
                                            @Html.Raw(EntryPerson.RealName)
                                        }
                                    }
                                </td>
                                <td>@item.SmeltCode</td>
                                @{
                                    if (string.IsNullOrEmpty(Model.Type))
                                    {
                                        if (item.Status.ToString() == "0")
                                        {
                                            <td style="color:green">@Html.Raw("未作废")</td>
                                        }
                                        else
                                        {
                                            <td style="color:red">@Html.Raw("已作废")</td>
                                        }
                                    }

                                }
                                @{
                                    var valobj = (Newtonsoft.Json.Linq.JObject)item.Chemistry.Object;
                                    foreach (var jobject in valobj)
                                    {
                                        var val = jobject.Value.ToString();
                                        if (val.SafeString() != string.Empty)
                                        {
                                            <td>@val</td>
                                        }
                                        else
                                        {
                                            <td>-</td>

                                        }
                                    }
                                }

                                @if (string.IsNullOrEmpty(Model.Type))
                                {
                                    <td>
                                        @if (item.Status == 0)
                                        {
                                            <a class="tablelink" href="javascript:void(0)" onclick="zuofei(@item.Id,1)" style="color:green">作废</a>
                                        }
                                        else
                                        {
                                            <a class="tablelink" href="javascript:void(0)" onclick="zuofei(@item.Id,0)" style="color:red">恢复</a>
                                        }
                                    </td>
                                }
                            </tr>
                        }

                    }

                }
            </tbody>
        </table>
        @await Component.InvokeAsync("PageList", new
        {
            PageSize = Model.PageSize,
            PageIndex = Model.PageIndex,
            PageCount = Model.PageCount,
            PageUrl = Request.GetAbsoluteUri(new List<KeyValuePair<string, string>>() {
new KeyValuePair<string, string>("pg","{0}")
}),
            PageText = "{0}",
            ShowCount = 6,
            ShowAll = false
        })
    </form>
    <script type="text/javascript">
        layui.use('form', function () {
            var form = layui.form;

            form.on('select(WorkShopCode)', function (data) {
                //GetBatCode('', 1, true);
            });
        });
        $(function () {
            @{
                if (!string.IsNullOrEmpty(Model.Type))
                {
                    @Html.Raw(@"$('.layui-table tbody tr ').click(function() {
                        var $this = $(this);
                        var SmeltCode = $this.attr('SmeltCode');
                        window.parent.Flash(SmeltCode);
                    });");

                }
            }

        })
        function zuofei(id, status) {

            var msg = '确定作废该化学数据?';
            if (parseInt(status) == 0) { msg = "确定恢复该数据?";}
                layer.confirm(msg, { icon: 3, title: '提示' }, function (index) {

                $.ajax({
                    type: "POST", url: '/Quality/ChemistryEdit?status=' + status + '&Id=' + id,
                    data: $("#form1").serialize(),
                    success: function (re) {
                        if (re.toString() == 'true') {
                            layer.msg('操作成功', { icon: 1 });
                            setTimeout(function () {
                                window.location.reload();
                            }, 2000);
                        } else {
                            layer.msg(re, { icon: 2 });
                        }
                        layer.close(loadLayer);
                    }, error: function () {
                        layer.close(loadLayer);
                        layer.msg('编辑成功，系统出现未知错误', { icon: 2 });
                    }
                });
            });

        }
                                                                            //function trclick(SmeltCode) {

                                                                            //    window.location.href = '/Manage/quality/PhysicsInfo?SmeltCode=' + SmeltCode;
                                                                            //}
    </script>
</body>

</html>
