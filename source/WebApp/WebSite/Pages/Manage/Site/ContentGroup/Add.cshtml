@page
@model WarrantyManage.Pages.Manage.Site.ContentGroup.AddModel
@inject DataLibrary.DataContext _db
@inject Common.IService.IContentGroupService _contentService

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加新闻</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    @{ await Html.RenderPartialAsync("_ValidationCssPartial");}
    <style>
        select {
            opacity: 1;
            border: 1px solid #ced9df;
            width: 157px;
            height: 34px;
            line-height: 34px;
            padding-left: 5px;
        }

        input {
            height: 100%;
            width: 150%;
            padding-left: 5px;
        }

        .forminfo {
            padding-left: 0px;
        }

        .tipbtn {
            margin-top: 0px;
            margin-left: 105px;
        }

        .tipinfo {
            margin-left: 50px;
        }

        .forminfo li label {
            width: 65px;
        }

        body {
            min-width: 0px;
        }

        .sure {
            margin: 15px 0 0 65px;
        }
    </style>
</head>
<body>
    <div class="rightinfo">
        <div id="addbox">

            <form id="form2" method="post">
                <div class="tipinfo">
                    <ul class="forminfo">
                        @if (Model.ContentGroup != null)
                        {
                            <input type="hidden" id="id" name="id" value="@Model.ContentGroup.Id" />
                        }
                        <li style="line-height: 34px;" class="chukuli">
                            <label>栏目名称</label>
                            @if (Model.ContentGroup != null)
                            {
                                <input name="ContentTitle" type="text" value="@Model.ContentGroup.ContentTitle" class="validate[required] scinput" />
                            }
                            else
                            {
                                <input name="ContentTitle" type="text" value="" class="validate[required] scinput" />
                            }
                        </li>
                        <li style="line-height: 34px;" class="rukuli">
                            <label>模型</label>
                            @{
                                if (Model.ModelList != null)
                                {

                                    if (Model.Disable)
                                    {
                                        <input hidden="hidden" name="ModelId" id="ModelId" value="@Model.ContentGroup.ModelId" />
                                    }

                                    <select name="ModelId" id="ModelId" disabled=@Model.Disable class="validate[required]">
                                        <option value="">请选择</option>
                                        @foreach (var item in Model.ModelList)
                                        {
                                            if (Model.ContentGroup != null && item.Id == Model.ContentGroup.ModelId)
                                            {
                                                <option value="@item.Id" selected="selected">@item.Description</option>
                                            }
                                            else
                                            {
                                                <option value="@item.Id">@item.Description</option>
                                            }
                                        }
                                    </select>
                                }
                            }

                        </li>
                        <li style="line-height: 34px;" class="rukuli">
                            <label>父级栏目</label>
                            @{
                                if (Model.ParDisable)
                                {
                                    <input hidden="hidden" name="ParId" id="ParId" />
                                }
                            }

                            <select name="ParId" class="validate[required]" disabled=@Model.ParDisable>
                                <optgroup label="无父级">
                                    <option value="0" selected="selected">一级栏目</option>
                                </optgroup>
                                <optgroup label="栏目列表" id="cglist"></optgroup>
                            </select>
                        </li>
                        <li>
                            @{
                                if (Model.ContentGroup != null)
                                {
                                    <input id="editBtn" type="button" class="sure" value="修改" />
                                }
                                else
                                {
                                    <input id="saveBtn" type="button" class="sure" value="保存" />
                                }
                            }
                        </li>
                    </ul>
                </div>
            </form>
        </div>

    </div>

    <script type="text/javascript">

        $(document).ready(function (e) {
            layui.use('laydate', function () {

            });

            $("#form2").validationEngine({
                validationEventTriggers: "blur",
                inlineValidation: true,
                success: false,
            });
        });

        $("#saveBtn").click(function () {
            submit('/ContentGroup/Add');
        });

        $("#editBtn").click(function () {
            submit('/ContentGroup/Edit');
        });

        //保存数据
        function submit(url) {

            var valid = $("#form2").validationEngine("validate");
            if (!valid) {
                return;
            }
            $.ajax({
                type: "POST",
                url: url,
                data: $("#form2").serialize(),
                success: function (re) {
                    if (re == "1") {
                        layer.msg('保存成功', { icon: 1 });
                        setTimeout(function () {
                            window.parent.location.reload();
                            var index = parent.layer.getFrameIndex(window.name); //获取当前窗体索引
                            parent.layer.close(index); //执行关闭
                        }, 2000)
                    } else if (re == "-1") {
                        layer.msg('该内容栏目已存在', { icon: 2 });
                    }else {
                        layer.msg('保存失败', { icon: 2 });
                    }
                }, error: function () {
                    layer.msg('保存失败，系统出现未知错误', { icon: 2 });
                }
            });
        };

        $(function () {
            var list = JSON.parse('@Html.Raw(Model.ContentListStr)');
            showall(list, 0)
        });

        function showall(list, parid) {
            for (var i = 0; i < list.length; i++) {

                var depth = "";
                for (var j = 0; j < list[i].Depth; j++) {
                   depth += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                }

                if (list[i].ParId == parid) {
                    var str = "";

                    if (list[i].Id == @Model.ParId) {
                        $('#ParId').val(list[i].Id);
                        str = "<option selected=\"selected\" value=\"" + list[i].Id + "\">" + depth + list[i].ContentTitle + "</option>";
                    } else {
                        str = "<option value=\"" + list[i].Id + "\">" + depth + list[i].ContentTitle + "</option>";
                    }

                    $("#cglist").append(str);
                    showall(list, list[i].Id);
                }
            }
        }

    </script>
</body>
</html>
